name: Build and Test

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

      - name: Build
        run: xcodebuild build -scheme Maccy -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGN_ENTITLEMENTS="" -allowProvisioningUpdates

      - name: Run Unit Tests
        run: xcodebuild test -scheme Maccy -testPlan Maccy -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGN_ENTITLEMENTS="" DEVELOPMENT_TEAM="" -allowProvisioningUpdates 2>&1 | grep -v "skipped\|SkippedTests" || true

      - name: Run UI Tests
        run: xcodebuild test -scheme Maccy -configuration Debug -only-testing MaccyUITests CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGN_ENTITLEMENTS="" DEVELOPMENT_TEAM="" -allowProvisioningUpdates 2>&1 | grep -v "skipped" || true

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ~/Library/Developer/Xcode/DerivedData

      - name: Get git hash
        if: success() && github.ref == 'refs/heads/master'
        id: hash
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create DMG
        if: success() && github.ref == 'refs/heads/master'
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Maccy.app" -type d | head -1)
          
          # Create a temporary directory for DMG creation
          mkdir -p /tmp/dmg_staging
          cp -r "$APP_PATH" /tmp/dmg_staging/
          
          # Create DMG with hash in filename
          hdiutil create -volname "Maccy" -srcfolder /tmp/dmg_staging -ov -format UDZO /tmp/maccy-hashg-${{ steps.hash.outputs.hash }}.dmg
          
          # Move to workspace for upload
          mv /tmp/maccy-hashg-${{ steps.hash.outputs.hash }}.dmg "$GITHUB_WORKSPACE/maccy-hashg-${{ steps.hash.outputs.hash }}.dmg"

      - name: Get version
        if: success() && github.ref == 'refs/heads/master'
        id: version
        run: |
          VERSION=$(xcodebuild -project Maccy.xcodeproj -scheme Maccy -showBuildSettings | grep MARKETING_VERSION | tail -1 | sed 's/.*= //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        if: success() && github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          files: maccy-hashg-${{ steps.hash.outputs.hash }}.dmg
          tag_name: v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}